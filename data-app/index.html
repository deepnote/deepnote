<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deepnote</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --bg-hover: #262c36;
      --bg-sidebar: #0d1117;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent: #3fb9a5;
      --accent-hover: #5fd3bd;
      --accent-light: rgba(63, 185, 165, 0.15);
      --border: #30363d;
      --border-light: #21262d;
      --success: #3fb950;
      --warning: #d29922;
      --error: #f85149;
      --purple: #a371f7;
      --blue: #58a6ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Layout */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar / Table of Contents */
    .sidebar {
      width: 280px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), #2dd4bf);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .logo-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .toc-section {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .toc-label {
      padding: 0.5rem 1.5rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .toc-list {
      list-style: none;
    }

    .toc-item {
      display: block;
      padding: 0.5rem 1.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
    }

    .toc-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toc-item.active {
      background: var(--accent-light);
      color: var(--accent);
      border-left-color: var(--accent);
    }

    .toc-item-sub {
      padding-left: 2.5rem;
      font-size: 0.8125rem;
    }

    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.625rem;
      background: var(--accent-light);
      border-radius: 12px;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--accent);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
    }

    /* Top Bar */
    .top-bar {
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 50;
      backdrop-filter: blur(8px);
    }

    .notebook-tabs {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-secondary);
      padding: 0.25rem;
      border-radius: 8px;
    }

    .notebook-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .notebook-tab:hover {
      color: var(--text-primary);
    }

    .notebook-tab.active {
      background: var(--bg-card);
      color: var(--text-primary);
      font-weight: 500;
    }

    .top-bar-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.875rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .toggle-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toggle-btn.active {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent);
    }

    .toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Content Area */
    .content-area {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Stats Row */
    .stats-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    /* Notebook Sections */
    .notebook {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    /* Section (H1 creates a section) */
    .section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .section-header:hover {
      background: var(--bg-hover);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-chevron {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .section.collapsed .section-chevron {
      transform: rotate(-90deg);
    }

    .section-content {
      border-top: 1px solid var(--border);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .section.collapsed .section-content {
      display: none;
    }

    /* Block */
    .block {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      overflow: hidden;
    }

    .block.text-block {
      background: transparent;
      border: none;
      padding: 0.5rem 0;
    }

    .block.text-block p {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }

    /* Code Block */
    .code-block-wrapper {
      position: relative;
    }

    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
    }

    .code-header:hover {
      background: var(--bg-hover);
    }

    .code-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .run-count {
      opacity: 0;
      transition: opacity 0.15s;
    }

    .code-header:hover .run-count {
      opacity: 1;
    }

    .code-icon {
      width: 14px;
      height: 14px;
      color: var(--purple);
    }

    .code-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .code-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s;
    }

    .code-block-wrapper.collapsed .code-toggle svg {
      transform: rotate(-90deg);
    }

    .code-content {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      padding: 1rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      background: var(--bg-primary);
      color: var(--text-secondary);
      max-height: 400px;
      overflow-y: auto;
    }

    .code-block-wrapper.collapsed .code-content {
      display: none;
    }

    /* Output */
    .output {
      background: var(--bg-secondary);
      padding: 1rem;
      border-top: 1px solid var(--border-light);
    }

    .output-label {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .output-label svg {
      width: 12px;
      height: 12px;
    }

    /* DataFrame */
    .dataframe-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .column-stat {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.625rem;
    }

    .column-name {
      font-weight: 600;
      font-size: 0.8125rem;
      color: var(--accent);
      margin-bottom: 0.125rem;
    }

    .column-dtype {
      font-size: 0.625rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.375rem;
    }

    .column-range {
      font-size: 0.6875rem;
      color: var(--text-secondary);
    }

    .histogram {
      display: flex;
      align-items: flex-end;
      gap: 1px;
      height: 32px;
      margin-top: 0.375rem;
    }

    .histogram-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 1px 1px 0 0;
      min-width: 3px;
      opacity: 0.6;
      transition: opacity 0.15s;
    }

    .histogram-bar:hover {
      opacity: 1;
    }

    /* Data Table */
    .data-table-wrapper {
      max-height: 350px;
      overflow: auto;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    .data-table th {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      padding: 0.625rem 0.75rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .data-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6875rem;
    }

    .data-table tr:hover td {
      background: var(--bg-hover);
    }

    .row-count {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    /* Image output */
    .image-output {
      display: flex;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: 6px;
    }

    .image-output img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }

    /* Stream output */
    .stream-output {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      padding: 0.75rem;
      background: var(--bg-primary);
      border-radius: 4px;
      white-space: pre-wrap;
      color: var(--text-secondary);
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      gap: 1rem;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error {
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      color: var(--error);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar / Table of Contents -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
            <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <span class="logo-text">deepnote</span>
      </div>
      
      <div class="toc-section">
        <div class="toc-label">Table of Contents</div>
        <nav id="toc" class="toc-list"></nav>
      </div>
      
      <div class="sidebar-footer">
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>Live</span>
        </div>
        <div id="last-updated" style="margin-top: 0.5rem;">Updated just now</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div id="notebook-tabs" class="notebook-tabs"></div>
        <div class="top-bar-actions">
          <button id="toggle-code" class="toggle-btn" onclick="toggleAllCode()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
            <span>Show Code</span>
          </button>
          <button id="toggle-collapse" class="toggle-btn" onclick="toggleAllSections()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <span>Expand All</span>
          </button>
        </div>
      </div>

      <div class="content-area">
        <div id="stats-section" class="stats-row"></div>
        <div id="content">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p style="color: var(--text-muted)">Loading notebook...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentNotebookIndex = 0
    let notebookData = null
    let showCode = false
    let allExpanded = true

    // Connect to SSE for live updates
    const eventSource = new EventSource('/events')
    eventSource.onmessage = (event) => {
      if (event.data === 'reload') {
        console.log('ðŸ”„ Reloading data...')
        loadNotebook()
      }
    }

    async function loadNotebook() {
      try {
        const res = await fetch('/api/notebook')
        notebookData = await res.json()
        
        document.getElementById('last-updated').textContent = `Updated ${formatDate(notebookData.metadata.modifiedAt || notebookData.metadata.createdAt)}`
        
        renderNotebookTabs()
        renderStats()
        renderContent()
        renderTOC()
      } catch (err) {
        document.getElementById('content').innerHTML = `
          <div class="error">
            <h3>Failed to load notebook</h3>
            <p>${err.message}</p>
          </div>
        `
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr)
      const now = new Date()
      const diff = now - date
      
      if (diff < 60000) return 'just now'
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`
      return date.toLocaleDateString()
    }

    function renderNotebookTabs() {
      const tabs = document.getElementById('notebook-tabs')
      const notebooks = notebookData.project.notebooks
      
      tabs.innerHTML = notebooks.map((nb, i) => `
        <button class="notebook-tab ${i === currentNotebookIndex ? 'active' : ''}" 
                onclick="switchNotebook(${i})">
          ${nb.name}
        </button>
      `).join('')
    }

    function switchNotebook(index) {
      currentNotebookIndex = index
      renderNotebookTabs()
      renderStats()
      renderContent()
      renderTOC()
    }

    function renderStats() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const stats = extractStats(notebook)
      
      document.getElementById('stats-section').innerHTML = `
        <div class="stat-item">
          <span class="stat-value">${stats.blockCount}</span>
          <span class="stat-label">Blocks</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.codeBlocks}</span>
          <span class="stat-label">Code Cells</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.outputs}</span>
          <span class="stat-label">Outputs</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.dataRows.toLocaleString()}</span>
          <span class="stat-label">Data Rows</span>
        </div>
      `
    }

    function extractStats(notebook) {
      let codeBlocks = 0
      let outputs = 0
      let dataRows = 0
      
      for (const block of notebook.blocks) {
        if (block.type === 'code' || block.type === 'sql') codeBlocks++
        if (block.outputs?.length) {
          outputs += block.outputs.length
          for (const output of block.outputs) {
            const df = output.data?.['application/vnd.deepnote.dataframe.v3+json']
            if (df?.row_count) dataRows += df.row_count
          }
        }
      }
      
      return { blockCount: notebook.blocks.length, codeBlocks, outputs, dataRows }
    }

    function renderTOC() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const toc = document.getElementById('toc')
      
      const sortedBlocks = [...notebook.blocks].sort((a, b) => 
        a.sortingKey.localeCompare(b.sortingKey)
      )
      
      const tocItems = []
      sortedBlocks.forEach((block, i) => {
        if (block.type === 'text-cell-h1') {
          tocItems.push({
            id: `section-${block.id}`,
            title: block.content || 'Untitled',
            isMain: true
          })
        } else if (block.type === 'text-cell-h2' || (block.type === 'markdown' && block.content?.startsWith('## '))) {
          const title = block.type === 'text-cell-h2' ? block.content : block.content.replace('## ', '')
          tocItems.push({
            id: `block-${block.id}`,
            title: title || 'Untitled',
            isMain: false
          })
        }
      })
      
      if (tocItems.length === 0) {
        tocItems.push({ id: 'content', title: 'Content', isMain: true })
      }
      
      toc.innerHTML = tocItems.map(item => `
        <a class="toc-item ${item.isMain ? '' : 'toc-item-sub'}" href="#${item.id}" onclick="scrollToSection('${item.id}')">
          ${escapeHtml(item.title)}
        </a>
      `).join('')
    }

    function scrollToSection(id) {
      const el = document.getElementById(id)
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' })
      }
    }

    function renderContent() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const content = document.getElementById('content')
      
      const sortedBlocks = [...notebook.blocks].sort((a, b) => 
        a.sortingKey.localeCompare(b.sortingKey)
      )
      
      // Group blocks into sections (H1 creates a new section)
      const sections = []
      let currentSection = { title: null, id: null, blocks: [] }
      
      sortedBlocks.forEach(block => {
        if (block.type === 'text-cell-h1') {
          if (currentSection.blocks.length > 0 || currentSection.title) {
            sections.push(currentSection)
          }
          currentSection = {
            title: block.content || 'Untitled',
            id: block.id,
            blocks: []
          }
        } else {
          currentSection.blocks.push(block)
        }
      })
      
      if (currentSection.blocks.length > 0 || currentSection.title) {
        sections.push(currentSection)
      }
      
      content.innerHTML = `<div class="notebook fade-in">${
        sections.map(section => renderSection(section)).join('')
      }</div>`
    }

    function renderSection(section) {
      if (!section.title && section.blocks.length === 0) return ''
      
      const blocksHtml = section.blocks.map(block => renderBlock(block)).join('')
      
      if (!section.title) {
        return `<div class="section-content">${blocksHtml}</div>`
      }
      
      return `
        <div id="section-${section.id}" class="section ${allExpanded ? '' : 'collapsed'}">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <h2>${escapeHtml(section.title)}</h2>
            </div>
            <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="section-content">
            ${blocksHtml}
          </div>
        </div>
      `
    }

    function renderBlock(block) {
      switch (block.type) {
        case 'code':
        case 'sql':
          return renderCodeBlock(block)
        case 'text-cell-p':
          return `<div id="block-${block.id}" class="block text-block"><p>${escapeHtml(block.content || '')}</p></div>`
        case 'text-cell-h2':
          return `<div id="block-${block.id}" class="block text-block"><h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">${escapeHtml(block.content || '')}</h3></div>`
        case 'markdown':
          return `<div id="block-${block.id}" class="block text-block">${renderMarkdown(block.content || '')}</div>`
        default:
          if (block.content) {
            return `<div id="block-${block.id}" class="block text-block"><p>${escapeHtml(block.content)}</p></div>`
          }
          return ''
      }
    }

    function renderCodeBlock(block) {
      const hasOutput = block.outputs?.length > 0
      const codeHidden = !showCode
      const lang = block.type === 'sql' ? 'SQL' : 'Python'
      
      return `
        <div id="block-${block.id}" class="block">
          <div class="code-block-wrapper ${codeHidden ? 'collapsed' : ''}">
            <div class="code-header" onclick="toggleCode(this)">
              <div class="code-meta">
                <svg class="code-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="16 18 22 12 16 6"></polyline>
                  <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                <span>${lang}</span>
                ${block.executionCount ? `<span class="run-count">Â· Run ${block.executionCount}</span>` : ''}
              </div>
              <div class="code-toggle">
                <span>${codeHidden ? 'Show' : 'Hide'}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="code-content">${escapeHtml(block.content || '')}</div>
          </div>
          ${renderOutputs(block.outputs)}
        </div>
      `
    }

    function toggleCode(header) {
      const wrapper = header.parentElement
      wrapper.classList.toggle('collapsed')
      const label = wrapper.querySelector('.code-toggle span')
      label.textContent = wrapper.classList.contains('collapsed') ? 'Show' : 'Hide'
    }

    function toggleSection(header) {
      const section = header.parentElement
      section.classList.toggle('collapsed')
    }

    function toggleAllCode() {
      showCode = !showCode
      const btn = document.getElementById('toggle-code')
      btn.classList.toggle('active', showCode)
      btn.querySelector('span').textContent = showCode ? 'Hide Code' : 'Show Code'
      
      document.querySelectorAll('.code-block-wrapper').forEach(wrapper => {
        wrapper.classList.toggle('collapsed', !showCode)
        const label = wrapper.querySelector('.code-toggle span')
        if (label) label.textContent = showCode ? 'Hide' : 'Show'
      })
    }

    function toggleAllSections() {
      allExpanded = !allExpanded
      const btn = document.getElementById('toggle-collapse')
      btn.querySelector('span').textContent = allExpanded ? 'Collapse All' : 'Expand All'
      
      document.querySelectorAll('.section').forEach(section => {
        section.classList.toggle('collapsed', !allExpanded)
      })
    }

    function renderOutputs(outputs) {
      if (!outputs?.length) return ''

      return outputs.map(output => {
        if (output.output_type === 'stream') {
          return `
            <div class="output">
              <div class="output-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Output
              </div>
              <div class="stream-output">${escapeHtml(output.text || '')}</div>
            </div>
          `
        }

        const data = output.data
        if (!data) return ''

        const dfData = data['application/vnd.deepnote.dataframe.v3+json']
        if (dfData) return renderDataFrame(dfData)

        if (data['image/png']) {
          return `
            <div class="output">
              <div class="output-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Figure
              </div>
              <div class="image-output">
                <img src="data:image/png;base64,${data['image/png']}" alt="Plot" />
              </div>
            </div>
          `
        }

        if (data['image/svg+xml']) {
          return `
            <div class="output">
              <div class="output-label">Figure</div>
              <div class="image-output">${data['image/svg+xml']}</div>
            </div>
          `
        }

        if (data['text/html']) {
          return `
            <div class="output">
              <div class="output-label">Output</div>
              <div style="overflow-x: auto;">${data['text/html']}</div>
            </div>
          `
        }

        if (data['text/plain']) {
          return `
            <div class="output">
              <div class="output-label">Output</div>
              <div class="stream-output">${escapeHtml(data['text/plain'])}</div>
            </div>
          `
        }

        return ''
      }).join('')
    }

    function renderDataFrame(df) {
      const columns = df.columns?.filter(c => c.name !== '_deepnote_index_column') || []
      const rows = df.rows || []
      const previewRows = rows.slice(0, 50)
      
      const statsHtml = columns.slice(0, 8).map(col => {
        const histogram = col.stats?.histogram
        const histogramHtml = histogram ? `
          <div class="histogram">
            ${histogram.map(bin => {
              const maxCount = Math.max(...histogram.map(b => b.count))
              const height = maxCount > 0 ? (bin.count / maxCount) * 100 : 0
              return `<div class="histogram-bar" style="height: ${height}%" title="${bin.count}"></div>`
            }).join('')}
          </div>
        ` : ''
        
        const minMax = col.stats?.min !== null && col.stats?.min !== undefined 
          ? `<div class="column-range">${formatNumber(col.stats.min)} â€” ${formatNumber(col.stats.max)}</div>`
          : ''
        
        return `
          <div class="column-stat">
            <div class="column-name">${col.name}</div>
            <div class="column-dtype">${col.dtype}</div>
            ${minMax}
            ${histogramHtml}
          </div>
        `
      }).join('')
      
      const tableHtml = `
        <div class="data-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>${columns.map(col => `<th>${col.name}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${previewRows.map(row => `
                <tr>${columns.map(col => `<td>${formatValue(row[col.name])}</td>`).join('')}</tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `
      
      return `
        <div class="output">
          <div class="output-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            DataFrame
          </div>
          <div class="row-count">
            <span>${df.row_count?.toLocaleString() || 0} rows</span>
            <span>Ã—</span>
            <span>${df.column_count || columns.length} cols</span>
          </div>
          <div class="dataframe-stats">${statsHtml}</div>
          ${tableHtml}
        </div>
      `
    }

    function formatNumber(val) {
      if (val === null || val === undefined) return 'â€”'
      const num = parseFloat(val)
      if (isNaN(num)) return val
      if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + 'M'
      if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'K'
      if (Number.isInteger(num)) return num.toString()
      return num.toFixed(2)
    }

    function formatValue(val) {
      if (val === null || val === undefined) return 'â€”'
      if (typeof val === 'number') {
        if (Number.isInteger(val)) return val.toLocaleString()
        return val.toFixed(2)
      }
      return escapeHtml(String(val))
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function renderMarkdown(text) {
      return text
        .split('\n\n')
        .map(para => {
          if (para.startsWith('## ')) return `<h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(para.slice(3))}</h3>`
          if (para.startsWith('# ')) return `<h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(para.slice(2))}</h2>`
          if (para.startsWith('**') && para.endsWith('**')) return `<p><strong>${escapeHtml(para.slice(2, -2))}</strong></p>`
          const withLinks = para.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--accent);">$1</a>')
          return `<p style="color: var(--text-secondary);">${withLinks}</p>`
        })
        .join('')
    }

    // Initial load
    loadNotebook()
  </script>
</body>
</html>
