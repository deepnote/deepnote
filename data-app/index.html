<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deepnote</title>
  <!-- Pyodide for in-browser Python execution -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --bg-hover: #262c36;
      --bg-sidebar: #0d1117;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent: #3fb9a5;
      --accent-hover: #5fd3bd;
      --accent-light: rgba(63, 185, 165, 0.15);
      --border: #30363d;
      --border-light: #21262d;
      --success: #3fb950;
      --warning: #d29922;
      --error: #f85149;
      --purple: #a371f7;
      --blue: #58a6ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Layout */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar / Table of Contents */
    .sidebar {
      width: 280px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), #2dd4bf);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .logo-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .toc-section {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .toc-label {
      padding: 0.5rem 1.5rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .toc-list {
      list-style: none;
    }

    .toc-item {
      display: block;
      padding: 0.5rem 1.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
    }

    .toc-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toc-item.active {
      background: var(--accent-light);
      color: var(--accent);
      border-left-color: var(--accent);
    }

    .toc-item-sub {
      padding-left: 2.5rem;
      font-size: 0.8125rem;
    }

    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.625rem;
      background: var(--accent-light);
      border-radius: 12px;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--accent);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Pyodide execution styles */
    .pyodide-banner {
      background: linear-gradient(135deg, var(--accent-light), rgba(88, 166, 255, 0.1));
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .pyodide-banner-text {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .pyodide-banner-text svg {
      width: 24px;
      height: 24px;
      color: var(--accent);
    }

    .pyodide-banner h3 {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.125rem;
    }

    .pyodide-banner p {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .pyodide-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 0.25rem 0.75rem;
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .pyodide-status.loading {
      color: var(--warning);
    }

    .pyodide-status.ready {
      color: var(--success);
    }

    .pyodide-status.error {
      color: var(--error);
    }

    .run-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.15s;
    }

    .run-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .run-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .run-btn svg {
      width: 16px;
      height: 16px;
    }

    .run-cell-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.15s;
      margin-left: auto;
    }

    .run-cell-btn:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .run-cell-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .run-cell-btn svg {
      width: 12px;
      height: 12px;
    }

    .cell-running {
      position: relative;
    }

    .cell-running::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--warning);
      border-radius: 2px;
      animation: pulse 1s infinite;
    }

    .cell-output-live {
      border-left: 3px solid var(--success);
      padding-left: 1rem;
      margin-top: 0.5rem;
    }

    .cell-output-error {
      border-left: 3px solid var(--error);
      background: rgba(248, 81, 73, 0.1);
      padding: 0.75rem 1rem;
      border-radius: 0 6px 6px 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      color: var(--error);
      white-space: pre-wrap;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--bg-secondary);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
    }

    /* Top Bar */
    .top-bar {
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 50;
      backdrop-filter: blur(8px);
    }

    .notebook-tabs {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-secondary);
      padding: 0.25rem;
      border-radius: 8px;
    }

    .notebook-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .notebook-tab:hover {
      color: var(--text-primary);
    }

    .notebook-tab.active {
      background: var(--bg-card);
      color: var(--text-primary);
      font-weight: 500;
    }

    .top-bar-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.875rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .toggle-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toggle-btn.active {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent);
    }

    .toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Content Area */
    .content-area {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Stats Row */
    .stats-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    /* Notebook Sections */
    .notebook {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    /* Section (H1 creates a section) */
    .section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .section-header:hover {
      background: var(--bg-hover);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-chevron {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .section.collapsed .section-chevron {
      transform: rotate(-90deg);
    }

    .section-content {
      border-top: 1px solid var(--border);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .section.collapsed .section-content {
      display: none;
    }

    /* Block */
    .block {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      overflow: hidden;
    }

    .block.text-block {
      background: transparent;
      border: none;
      padding: 0.5rem 0;
    }

    .block.text-block p {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }

    /* Code Block */
    .code-block-wrapper {
      position: relative;
    }

    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
    }

    .code-header:hover {
      background: var(--bg-hover);
    }

    .code-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .run-count {
      opacity: 0;
      transition: opacity 0.15s;
    }

    .code-header:hover .run-count {
      opacity: 1;
    }

    .code-icon {
      width: 14px;
      height: 14px;
      color: var(--purple);
    }

    .code-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .code-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s;
    }

    .code-block-wrapper.collapsed .code-toggle svg {
      transform: rotate(-90deg);
    }

    .code-content {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      padding: 1rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      background: var(--bg-primary);
      color: var(--text-secondary);
      max-height: 400px;
      overflow-y: auto;
    }

    .code-block-wrapper.collapsed .code-content,
    .code-block-wrapper.collapsed .code-editor-wrapper {
      display: none;
    }

    .code-editor {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      line-height: 1.6;
      padding: 1rem;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: none;
      width: 100%;
      min-height: 100px;
      resize: vertical;
      outline: none;
      tab-size: 4;
      -moz-tab-size: 4;
    }

    .code-editor:focus {
      background: #0a0d12;
      box-shadow: inset 0 0 0 1px var(--accent);
    }

    .code-editor:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--bg-secondary);
    }

    .code-editor-wrapper {
      position: relative;
    }

    .code-modified-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--warning);
      color: var(--bg-primary);
      font-size: 0.625rem;
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      text-transform: uppercase;
      pointer-events: none;
    }

    /* Output */
    .output {
      background: var(--bg-secondary);
      padding: 1rem;
      border-top: 1px solid var(--border-light);
    }

    .output-label {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .output-label svg {
      width: 12px;
      height: 12px;
    }

    /* DataFrame */
    .dataframe-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .column-stat {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.625rem;
    }

    .column-name {
      font-weight: 600;
      font-size: 0.8125rem;
      color: var(--accent);
      margin-bottom: 0.125rem;
    }

    .column-dtype {
      font-size: 0.625rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.375rem;
    }

    .column-range {
      font-size: 0.6875rem;
      color: var(--text-secondary);
    }

    .histogram {
      display: flex;
      align-items: flex-end;
      gap: 1px;
      height: 32px;
      margin-top: 0.375rem;
    }

    .histogram-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 1px 1px 0 0;
      min-width: 3px;
      opacity: 0.6;
      transition: opacity 0.15s;
    }

    .histogram-bar:hover {
      opacity: 1;
    }

    /* Data Table */
    .data-table-wrapper {
      max-height: 350px;
      overflow: auto;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    .data-table th {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      padding: 0.625rem 0.75rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .data-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6875rem;
    }

    .data-table tr:hover td {
      background: var(--bg-hover);
    }

    .row-count {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    /* Image output */
    .image-output {
      display: flex;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: 6px;
    }

    .image-output img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }

    /* Stream output */
    .stream-output {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      padding: 0.75rem;
      background: var(--bg-primary);
      border-radius: 4px;
      white-space: pre-wrap;
      color: var(--text-secondary);
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      gap: 1rem;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error {
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      color: var(--error);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar / Table of Contents -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
            <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <span class="logo-text">deepnote</span>
      </div>
      
      <div class="toc-section">
        <div class="toc-label">Table of Contents</div>
        <nav id="toc" class="toc-list"></nav>
      </div>
      
      <div class="sidebar-footer">
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>Live</span>
        </div>
        <div id="last-updated" style="margin-top: 0.5rem;">Updated just now</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div id="notebook-tabs" class="notebook-tabs"></div>
        <div class="top-bar-actions">
          <button id="toggle-code" class="toggle-btn" onclick="toggleAllCode()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
            <span>Show Code</span>
          </button>
          <button id="toggle-collapse" class="toggle-btn" onclick="toggleAllSections()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <span>Expand All</span>
          </button>
        </div>
      </div>

      <!-- Pyodide Execution Banner -->
      <div id="pyodide-banner" class="pyodide-banner" style="display: none;">
        <div class="pyodide-banner-text">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
          </svg>
          <div>
            <h3>Run in Browser with WebAssembly</h3>
            <p id="pyodide-message">Python execution powered by Pyodide</p>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span id="pyodide-status" class="pyodide-status">Not loaded</span>
          <button id="init-pyodide-btn" class="run-btn" onclick="initPyodide()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            <span>Load Python</span>
          </button>
          <button id="run-all-btn" class="run-btn" onclick="runAllCells()" disabled style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <span>Run All</span>
          </button>
        </div>
      </div>
      <div id="pyodide-progress" style="display: none; padding: 0 2rem;">
        <div class="progress-bar">
          <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>

      <div class="content-area">
        <div id="stats-section" class="stats-row"></div>
        <div id="content">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p style="color: var(--text-muted)">Loading notebook...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentNotebookIndex = 0
    let notebookData = null
    let showCode = false
    let allExpanded = true

    // Pyodide state
    let pyodide = null
    let pyodideReady = false
    let pyodideLoading = false
    
    // Store for edited code (blockId -> editedCode)
    const editedCode = new Map()

    // Pyodide initialization
    async function initPyodide() {
      if (pyodideLoading || pyodideReady) return

      pyodideLoading = true
      const statusEl = document.getElementById('pyodide-status')
      const messageEl = document.getElementById('pyodide-message')
      const initBtn = document.getElementById('init-pyodide-btn')
      const runAllBtn = document.getElementById('run-all-btn')
      const progressEl = document.getElementById('pyodide-progress')
      const progressFill = document.getElementById('progress-bar-fill')

      initBtn.disabled = true
      initBtn.innerHTML = '<svg class="loading-spinner" style="width:16px;height:16px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="12"></circle></svg><span>Loading...</span>'
      
      statusEl.textContent = 'Loading Pyodide...'
      statusEl.className = 'pyodide-status loading'
      progressEl.style.display = 'block'
      progressFill.style.width = '10%'

      try {
        messageEl.textContent = 'Loading Python runtime...'
        pyodide = await loadPyodide()
        progressFill.style.width = '30%'

        messageEl.textContent = 'Installing numpy...'
        await pyodide.loadPackage('numpy')
        progressFill.style.width = '45%'

        messageEl.textContent = 'Installing pandas...'
        await pyodide.loadPackage('pandas')
        progressFill.style.width = '60%'

        messageEl.textContent = 'Installing scikit-learn...'
        await pyodide.loadPackage('scikit-learn')
        progressFill.style.width = '75%'

        messageEl.textContent = 'Installing matplotlib...'
        await pyodide.loadPackage('matplotlib')
        progressFill.style.width = '85%'

        messageEl.textContent = 'Installing seaborn via micropip...'
        await pyodide.loadPackage('micropip')
        const micropip = pyodide.pyimport('micropip')
        await micropip.install('seaborn')
        progressFill.style.width = '95%'

        // Setup matplotlib for inline display
        await pyodide.runPythonAsync(`
import matplotlib
matplotlib.use('AGG')
import matplotlib.pyplot as plt
import io
import base64

def _deepnote_get_figure_base64():
    """Capture current matplotlib figure as base64 PNG"""
    buf = io.BytesIO()
    plt.savefig(buf, format='png', dpi=100, bbox_inches='tight', facecolor='#1c2128', edgecolor='none')
    buf.seek(0)
    img_base64 = base64.b64encode(buf.read()).decode('utf-8')
    plt.close('all')
    return img_base64

# Set dark style for plots
plt.style.use('dark_background')
plt.rcParams['figure.facecolor'] = '#1c2128'
plt.rcParams['axes.facecolor'] = '#161b22'
plt.rcParams['axes.edgecolor'] = '#30363d'
plt.rcParams['axes.labelcolor'] = '#e6edf3'
plt.rcParams['text.color'] = '#e6edf3'
plt.rcParams['xtick.color'] = '#8b949e'
plt.rcParams['ytick.color'] = '#8b949e'
plt.rcParams['grid.color'] = '#30363d'
`)
        progressFill.style.width = '100%'

        pyodideReady = true
        pyodideLoading = false

        statusEl.textContent = 'Ready'
        statusEl.className = 'pyodide-status ready'
        messageEl.textContent = 'Python ready! Click "Run All" or run individual cells.'
        
        initBtn.style.display = 'none'
        runAllBtn.style.display = 'flex'
        runAllBtn.disabled = false
        
        setTimeout(() => { progressEl.style.display = 'none' }, 500)

        // Re-render to add run buttons to cells
        renderContent()

      } catch (error) {
        console.error('Pyodide initialization failed:', error)
        statusEl.textContent = 'Failed'
        statusEl.className = 'pyodide-status error'
        messageEl.textContent = `Error: ${error.message}`
        initBtn.disabled = false
        initBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg><span>Retry</span>'
        pyodideLoading = false
      }
    }

    // Run a single code cell
    async function runCell(blockId) {
      if (!pyodideReady) return

      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const block = notebook.blocks.find(b => b.id === blockId)
      if (!block || (block.type !== 'code' && block.type !== 'sql')) return

      const blockEl = document.getElementById(`block-${blockId}`)
      const outputContainer = blockEl.querySelector('.live-output-container') || createLiveOutputContainer(blockEl)
      
      blockEl.classList.add('cell-running')
      outputContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Running...</div>'

      try {
        // Use edited code if available, otherwise original
        let code = editedCode.get(blockId) || block.content || ''
        
        // Skip SQL blocks - they can't run in Pyodide without a database
        if (block.type === 'sql') {
          outputContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">‚ÑπÔ∏è SQL blocks use pre-computed results (no database in browser)</div>'
          blockEl.classList.remove('cell-running')
          return
        }
        
        // Skip bash/shell commands
        if (code.trim().startsWith('%%bash') || code.trim().startsWith('!')) {
          outputContainer.innerHTML = '<div style="color: var(--warning); font-size: 0.8125rem;">‚ö†Ô∏è Shell commands skipped in browser</div>'
          blockEl.classList.remove('cell-running')
          return
        }

        // Comment out magic commands
        code = code.split('\n').map(line => {
          if (line.trim().startsWith('%') || line.trim().startsWith('!')) {
            return '# ' + line + '  # (skipped in browser)'
          }
          return line
        }).join('\n')

        // Capture stdout
        await pyodide.runPythonAsync(`
import sys
from io import StringIO
_deepnote_stdout = StringIO()
_deepnote_old_stdout = sys.stdout
sys.stdout = _deepnote_stdout
`)

        // Run the code
        const result = await pyodide.runPythonAsync(code)

        // Get stdout
        const stdout = await pyodide.runPythonAsync(`
sys.stdout = _deepnote_old_stdout
_deepnote_stdout.getvalue()
`)

        // Check if there's a matplotlib figure
        const hasFigure = await pyodide.runPythonAsync(`
len(plt.get_fignums()) > 0
`)

        let outputHtml = ''

        if (stdout && stdout.trim()) {
          outputHtml += `<div class="stream-output" style="margin-bottom: 0.5rem;">${escapeHtml(stdout)}</div>`
        }

        if (hasFigure) {
          const imgBase64 = await pyodide.runPythonAsync('_deepnote_get_figure_base64()')
          outputHtml += `<div class="image-output"><img src="data:image/png;base64,${imgBase64}" alt="Plot" /></div>`
        }

        if (result !== undefined && result !== null && !hasFigure) {
          const resultStr = String(result)
          if (resultStr && resultStr !== 'None') {
            outputHtml += `<div class="stream-output">${escapeHtml(resultStr)}</div>`
          }
        }

        if (outputHtml) {
          outputContainer.innerHTML = `<div class="cell-output-live">${outputHtml}</div>`
        } else {
          outputContainer.innerHTML = '<div style="color: var(--success); font-size: 0.8125rem;">‚úì Done</div>'
        }

      } catch (error) {
        outputContainer.innerHTML = `<div class="cell-output-error">${escapeHtml(error.message)}</div>`
      }

      blockEl.classList.remove('cell-running')
    }

    function createLiveOutputContainer(blockEl) {
      const container = document.createElement('div')
      container.className = 'live-output-container'
      container.style.marginTop = '0.5rem'
      blockEl.appendChild(container)
      return container
    }

    // Run all code cells in order
    async function runAllCells() {
      if (!pyodideReady) return

      const runAllBtn = document.getElementById('run-all-btn')
      runAllBtn.disabled = true
      runAllBtn.innerHTML = '<svg class="loading-spinner" style="width:16px;height:16px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="12"></circle></svg><span>Running...</span>'

      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const sortedBlocks = [...notebook.blocks].sort((a, b) => 
        a.sortingKey.localeCompare(b.sortingKey)
      )

      const codeBlocks = sortedBlocks.filter(b => b.type === 'code' || b.type === 'sql')

      for (const block of codeBlocks) {
        await runCell(block.id)
      }

      runAllBtn.disabled = false
      runAllBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>Run All</span>'
    }

    // Connect to SSE for live updates
    const eventSource = new EventSource('/events')
    eventSource.onmessage = (event) => {
      if (event.data === 'reload') {
        console.log('üîÑ Reloading data...')
        loadNotebook()
      }
    }

    async function loadNotebook() {
      try {
        const res = await fetch('/api/notebook')
        notebookData = await res.json()
        
        document.getElementById('last-updated').textContent = `Updated ${formatDate(notebookData.metadata.modifiedAt || notebookData.metadata.createdAt)}`
        
        // Show Pyodide banner if notebook has code blocks
        const notebook = notebookData.project.notebooks[currentNotebookIndex]
        const hasCodeBlocks = notebook.blocks.some(b => b.type === 'code' || b.type === 'sql')
        if (hasCodeBlocks) {
          document.getElementById('pyodide-banner').style.display = 'flex'
        }
        
        renderNotebookTabs()
        renderStats()
        renderContent()
        renderTOC()
      } catch (err) {
        document.getElementById('content').innerHTML = `
          <div class="error">
            <h3>Failed to load notebook</h3>
            <p>${err.message}</p>
          </div>
        `
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr)
      const now = new Date()
      const diff = now - date
      
      if (diff < 60000) return 'just now'
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`
      return date.toLocaleDateString()
    }

    function renderNotebookTabs() {
      const tabs = document.getElementById('notebook-tabs')
      const notebooks = notebookData.project.notebooks
      
      tabs.innerHTML = notebooks.map((nb, i) => `
        <button class="notebook-tab ${i === currentNotebookIndex ? 'active' : ''}" 
                onclick="switchNotebook(${i})">
          ${nb.name}
        </button>
      `).join('')
    }

    function switchNotebook(index) {
      currentNotebookIndex = index
      renderNotebookTabs()
      renderStats()
      renderContent()
      renderTOC()
    }

    function renderStats() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const stats = extractStats(notebook)
      
      document.getElementById('stats-section').innerHTML = `
        <div class="stat-item">
          <span class="stat-value">${stats.blockCount}</span>
          <span class="stat-label">Blocks</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.codeBlocks}</span>
          <span class="stat-label">Code Cells</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.outputs}</span>
          <span class="stat-label">Outputs</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.dataRows.toLocaleString()}</span>
          <span class="stat-label">Data Rows</span>
        </div>
      `
    }

    function extractStats(notebook) {
      let codeBlocks = 0
      let outputs = 0
      let dataRows = 0
      
      for (const block of notebook.blocks) {
        if (block.type === 'code' || block.type === 'sql') codeBlocks++
        if (block.outputs?.length) {
          outputs += block.outputs.length
          for (const output of block.outputs) {
            const df = output.data?.['application/vnd.deepnote.dataframe.v3+json']
            if (df?.row_count) dataRows += df.row_count
          }
        }
      }
      
      return { blockCount: notebook.blocks.length, codeBlocks, outputs, dataRows }
    }

    function renderTOC() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const toc = document.getElementById('toc')
      
      const sortedBlocks = [...notebook.blocks].sort((a, b) => 
        a.sortingKey.localeCompare(b.sortingKey)
      )
      
      const tocItems = []
      sortedBlocks.forEach((block, i) => {
        if (block.type === 'text-cell-h1') {
          tocItems.push({
            id: `section-${block.id}`,
            title: block.content || 'Untitled',
            isMain: true
          })
        } else if (block.type === 'text-cell-h2' || (block.type === 'markdown' && block.content?.startsWith('## '))) {
          const title = block.type === 'text-cell-h2' ? block.content : block.content.replace('## ', '')
          tocItems.push({
            id: `block-${block.id}`,
            title: title || 'Untitled',
            isMain: false
          })
        }
      })
      
      if (tocItems.length === 0) {
        tocItems.push({ id: 'content', title: 'Content', isMain: true })
      }
      
      toc.innerHTML = tocItems.map(item => `
        <a class="toc-item ${item.isMain ? '' : 'toc-item-sub'}" href="#${item.id}" onclick="scrollToSection('${item.id}')">
          ${escapeHtml(item.title)}
        </a>
      `).join('')
    }

    function scrollToSection(id) {
      const el = document.getElementById(id)
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' })
      }
    }

    function renderContent() {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const content = document.getElementById('content')
      
      const sortedBlocks = [...notebook.blocks].sort((a, b) => 
        a.sortingKey.localeCompare(b.sortingKey)
      )
      
      // Group blocks into sections (H1 creates a new section)
      const sections = []
      let currentSection = { title: null, id: null, blocks: [] }
      
      sortedBlocks.forEach(block => {
        if (block.type === 'text-cell-h1') {
          if (currentSection.blocks.length > 0 || currentSection.title) {
            sections.push(currentSection)
          }
          currentSection = {
            title: block.content || 'Untitled',
            id: block.id,
            blocks: []
          }
        } else {
          currentSection.blocks.push(block)
        }
      })
      
      if (currentSection.blocks.length > 0 || currentSection.title) {
        sections.push(currentSection)
      }
      
      content.innerHTML = `<div class="notebook fade-in">${
        sections.map(section => renderSection(section)).join('')
      }</div>`
    }

    function renderSection(section) {
      if (!section.title && section.blocks.length === 0) return ''
      
      const blocksHtml = section.blocks.map(block => renderBlock(block)).join('')
      
      if (!section.title) {
        return `<div class="section-content">${blocksHtml}</div>`
      }
      
      return `
        <div id="section-${section.id}" class="section ${allExpanded ? '' : 'collapsed'}">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <h2>${escapeHtml(section.title)}</h2>
            </div>
            <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="section-content">
            ${blocksHtml}
          </div>
        </div>
      `
    }

    function renderBlock(block) {
      switch (block.type) {
        case 'code':
        case 'sql':
          return renderCodeBlock(block)
        case 'text-cell-p':
          return `<div id="block-${block.id}" class="block text-block"><p>${escapeHtml(block.content || '')}</p></div>`
        case 'text-cell-h2':
          return `<div id="block-${block.id}" class="block text-block"><h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">${escapeHtml(block.content || '')}</h3></div>`
        case 'markdown':
          return `<div id="block-${block.id}" class="block text-block">${renderMarkdown(block.content || '')}</div>`
        default:
          if (block.content) {
            return `<div id="block-${block.id}" class="block text-block"><p>${escapeHtml(block.content)}</p></div>`
          }
          return ''
      }
    }

    function renderCodeBlock(block) {
      const hasOutput = block.outputs?.length > 0
      const codeHidden = !showCode
      const lang = block.type === 'sql' ? 'SQL' : 'Python'
      const isEditable = pyodideReady && block.type !== 'sql'
      const currentCode = editedCode.get(block.id) || block.content || ''
      const isModified = editedCode.has(block.id)
      
      const runButton = pyodideReady ? `
        <button class="run-cell-btn" onclick="event.stopPropagation(); runCell('${block.id}')" title="Run this cell">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Run
        </button>
      ` : ''
      
      const codeDisplay = isEditable ? `
        <div class="code-editor-wrapper">
          ${isModified ? '<span class="code-modified-badge">Modified</span>' : ''}
          <textarea 
            class="code-editor" 
            data-block-id="${block.id}"
            spellcheck="false"
            oninput="onCodeEdit('${block.id}', this.value)"
            onkeydown="handleEditorKeydown(event, this)"
          >${escapeHtml(currentCode)}</textarea>
        </div>
      ` : `<div class="code-content">${escapeHtml(block.content || '')}</div>`
      
      return `
        <div id="block-${block.id}" class="block">
          <div class="code-block-wrapper ${codeHidden ? 'collapsed' : ''}">
            <div class="code-header" onclick="toggleCode(this)">
              <div class="code-meta">
                <svg class="code-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="16 18 22 12 16 6"></polyline>
                  <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                <span>${lang}</span>
                ${block.executionCount ? `<span class="run-count">¬∑ Run ${block.executionCount}</span>` : ''}
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                ${runButton}
                <div class="code-toggle">
                  <span>${codeHidden ? 'Show' : 'Hide'}</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
              </div>
            </div>
            ${codeDisplay}
          </div>
          ${renderOutputs(block.outputs)}
        </div>
      `
    }
    
    function onCodeEdit(blockId, newCode) {
      const notebook = notebookData.project.notebooks[currentNotebookIndex]
      const block = notebook.blocks.find(b => b.id === blockId)
      
      if (block && newCode !== block.content) {
        editedCode.set(blockId, newCode)
      } else {
        editedCode.delete(blockId)
      }
      
      // Update the modified badge without full re-render
      const wrapper = document.querySelector(`[data-block-id="${blockId}"]`)?.parentElement
      if (wrapper) {
        const existingBadge = wrapper.querySelector('.code-modified-badge')
        if (editedCode.has(blockId) && !existingBadge) {
          wrapper.insertAdjacentHTML('afterbegin', '<span class="code-modified-badge">Modified</span>')
        } else if (!editedCode.has(blockId) && existingBadge) {
          existingBadge.remove()
        }
      }
    }
    
    function handleEditorKeydown(event, textarea) {
      // Handle Tab key for indentation
      if (event.key === 'Tab') {
        event.preventDefault()
        const start = textarea.selectionStart
        const end = textarea.selectionEnd
        const value = textarea.value
        
        if (event.shiftKey) {
          // Shift+Tab: remove indentation
          const lineStart = value.lastIndexOf('\n', start - 1) + 1
          const lineContent = value.substring(lineStart, end)
          if (lineContent.startsWith('    ')) {
            textarea.value = value.substring(0, lineStart) + lineContent.substring(4)
            textarea.selectionStart = textarea.selectionEnd = start - 4
          } else if (lineContent.startsWith('\t')) {
            textarea.value = value.substring(0, lineStart) + lineContent.substring(1)
            textarea.selectionStart = textarea.selectionEnd = start - 1
          }
        } else {
          // Tab: add indentation
          textarea.value = value.substring(0, start) + '    ' + value.substring(end)
          textarea.selectionStart = textarea.selectionEnd = start + 4
        }
        
        onCodeEdit(textarea.dataset.blockId, textarea.value)
      }
      
      // Ctrl/Cmd + Enter to run cell
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault()
        runCell(textarea.dataset.blockId)
      }
    }

    function toggleCode(header) {
      const wrapper = header.parentElement
      wrapper.classList.toggle('collapsed')
      const label = wrapper.querySelector('.code-toggle span')
      label.textContent = wrapper.classList.contains('collapsed') ? 'Show' : 'Hide'
    }

    function toggleSection(header) {
      const section = header.parentElement
      section.classList.toggle('collapsed')
    }

    function toggleAllCode() {
      showCode = !showCode
      const btn = document.getElementById('toggle-code')
      btn.classList.toggle('active', showCode)
      btn.querySelector('span').textContent = showCode ? 'Hide Code' : 'Show Code'
      
      document.querySelectorAll('.code-block-wrapper').forEach(wrapper => {
        wrapper.classList.toggle('collapsed', !showCode)
        const label = wrapper.querySelector('.code-toggle span')
        if (label) label.textContent = showCode ? 'Hide' : 'Show'
      })
    }

    function toggleAllSections() {
      allExpanded = !allExpanded
      const btn = document.getElementById('toggle-collapse')
      btn.querySelector('span').textContent = allExpanded ? 'Collapse All' : 'Expand All'
      
      document.querySelectorAll('.section').forEach(section => {
        section.classList.toggle('collapsed', !allExpanded)
      })
    }

    function renderOutputs(outputs) {
      if (!outputs?.length) return ''

      return outputs.map(output => {
        if (output.output_type === 'stream') {
          return `
            <div class="output">
              <div class="output-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Output
              </div>
              <div class="stream-output">${escapeHtml(output.text || '')}</div>
            </div>
          `
        }

        const data = output.data
        if (!data) return ''

        const dfData = data['application/vnd.deepnote.dataframe.v3+json']
        if (dfData) return renderDataFrame(dfData)

        if (data['image/png']) {
          return `
            <div class="output">
              <div class="output-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Figure
              </div>
              <div class="image-output">
                <img src="data:image/png;base64,${data['image/png']}" alt="Plot" />
              </div>
            </div>
          `
        }

        if (data['image/svg+xml']) {
          return `
            <div class="output">
              <div class="output-label">Figure</div>
              <div class="image-output">${data['image/svg+xml']}</div>
            </div>
          `
        }

        if (data['text/html']) {
          return `
            <div class="output">
              <div class="output-label">Output</div>
              <div style="overflow-x: auto;">${data['text/html']}</div>
            </div>
          `
        }

        if (data['text/plain']) {
          return `
            <div class="output">
              <div class="output-label">Output</div>
              <div class="stream-output">${escapeHtml(data['text/plain'])}</div>
            </div>
          `
        }

        return ''
      }).join('')
    }

    function renderDataFrame(df) {
      const columns = df.columns?.filter(c => c.name !== '_deepnote_index_column') || []
      const rows = df.rows || []
      const previewRows = rows.slice(0, 50)
      
      const statsHtml = columns.slice(0, 8).map(col => {
        const histogram = col.stats?.histogram
        const histogramHtml = histogram ? `
          <div class="histogram">
            ${histogram.map(bin => {
              const maxCount = Math.max(...histogram.map(b => b.count))
              const height = maxCount > 0 ? (bin.count / maxCount) * 100 : 0
              return `<div class="histogram-bar" style="height: ${height}%" title="${bin.count}"></div>`
            }).join('')}
          </div>
        ` : ''
        
        const minMax = col.stats?.min !== null && col.stats?.min !== undefined 
          ? `<div class="column-range">${formatNumber(col.stats.min)} ‚Äî ${formatNumber(col.stats.max)}</div>`
          : ''
        
        return `
          <div class="column-stat">
            <div class="column-name">${col.name}</div>
            <div class="column-dtype">${col.dtype}</div>
            ${minMax}
            ${histogramHtml}
          </div>
        `
      }).join('')
      
      const tableHtml = `
        <div class="data-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>${columns.map(col => `<th>${col.name}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${previewRows.map(row => `
                <tr>${columns.map(col => `<td>${formatValue(row[col.name])}</td>`).join('')}</tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `
      
      return `
        <div class="output">
          <div class="output-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            DataFrame
          </div>
          <div class="row-count">
            <span>${df.row_count?.toLocaleString() || 0} rows</span>
            <span>√ó</span>
            <span>${df.column_count || columns.length} cols</span>
          </div>
          <div class="dataframe-stats">${statsHtml}</div>
          ${tableHtml}
        </div>
      `
    }

    function formatNumber(val) {
      if (val === null || val === undefined) return '‚Äî'
      const num = parseFloat(val)
      if (isNaN(num)) return val
      if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + 'M'
      if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'K'
      if (Number.isInteger(num)) return num.toString()
      return num.toFixed(2)
    }

    function formatValue(val) {
      if (val === null || val === undefined) return '‚Äî'
      if (typeof val === 'number') {
        if (Number.isInteger(val)) return val.toLocaleString()
        return val.toFixed(2)
      }
      return escapeHtml(String(val))
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function renderMarkdown(text) {
      return text
        .split('\n\n')
        .map(para => {
          if (para.startsWith('## ')) return `<h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(para.slice(3))}</h3>`
          if (para.startsWith('# ')) return `<h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(para.slice(2))}</h2>`
          if (para.startsWith('**') && para.endsWith('**')) return `<p><strong>${escapeHtml(para.slice(2, -2))}</strong></p>`
          const withLinks = para.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--accent);">$1</a>')
          return `<p style="color: var(--text-secondary);">${withLinks}</p>`
        })
        .join('')
    }

    // Initial load
    loadNotebook()
  </script>
</body>
</html>
