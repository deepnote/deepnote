name: CD PyPI CLI

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build-wheels:
    name: Build wheel (${{ matrix.os }})
    if: startsWith(github.event.release.tag_name, '@deepnote/cli@')
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - macos-14
          - windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI package
        run: pnpm --filter @deepnote/cli... run build

      - name: Sync PyPI version with CLI version
        run: python packages/cli/pypi/scripts/set_version.py

      - name: Determine binary name
        id: binary
        shell: bash
        run: |
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            echo "name=deepnote.exe" >> "$GITHUB_OUTPUT"
          else
            echo "name=deepnote" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare binary directory
        shell: bash
        run: |
          mkdir -p packages/cli/pypi/src/deepnote_cli/bin
          rm -f packages/cli/pypi/src/deepnote_cli/bin/deepnote
          rm -f packages/cli/pypi/src/deepnote_cli/bin/deepnote.exe

      - name: Build Bun executable
        run: bun build packages/cli/dist/bin.js --compile --outfile packages/cli/pypi/src/deepnote_cli/bin/${{ steps.binary.outputs.name }}

      - name: Install Python build tools
        run: python -m pip install --upgrade pip build wheel setuptools

      - name: Build wheel
        run: python -m build --wheel packages/cli/pypi --outdir packages/cli/pypi/dist

      - name: Smoke test wheel
        shell: bash
        run: |
          python -m pip install --force-reinstall packages/cli/pypi/dist/*.whl
          python -m deepnote_cli --version

      - name: Upload wheel artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: wheel-${{ matrix.os }}
          path: packages/cli/pypi/dist/*.whl
          if-no-files-found: error

  publish:
    name: Publish to PyPI
    if: startsWith(github.event.release.tag_name, '@deepnote/cli@')
    needs: build-wheels
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: release
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: dist
          merge-multiple: true

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Validate wheel metadata
        run: |
          python -m pip install --upgrade pip twine
          python -m twine check dist/*.whl

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
        with:
          packages-dir: dist
